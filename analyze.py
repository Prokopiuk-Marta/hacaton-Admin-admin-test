import os
import json
import time
from concurrent.futures import ThreadPoolExecutor
from dotenv import load_dotenv
from openai import OpenAI
from pydantic import BaseModel, Field
from typing import Literal

load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")

if not api_key:
    raise ValueError("–ö–ª—é—á OPENAI_API_KEY –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!")

client = OpenAI(api_key=api_key)


# 1. –°–£–í–û–†–ê –¢–ò–ü–Ü–ó–ê–¶–Ü–Ø –Ü –ü–û–õ–ï REASONING
class AnalysisResult(BaseModel):
    reasoning: str = Field(
        description="–î–µ—Ç–∞–ª—å–Ω–µ –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è. –ß–û–ú–£ —Å–∞–º–µ —Ç–∞–∫–∞ –æ—Ü—ñ–Ω–∫–∞ —Ç–∞ –∑–∞–¥–æ–≤–æ–ª–µ–Ω—ñ—Å—Ç—å? –Ø–∫—ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Ä–µ–ø–ª—ñ–∫–∏ —á–∏ –¥—ñ—ó –¥–æ–≤–æ–¥—è—Ç—å –Ω–∞—è–≤–Ω—ñ—Å—Ç—å/–≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –ø–æ–º–∏–ª–æ–∫?")
    intent: str = Field(
        description="–í–∏–∑–Ω–∞—á–µ–Ω–∞ —Ç–µ–º–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: —Ç–µ—Ö–Ω—ñ—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏, –ø—Ä–æ–±–ª–µ–º–∏ –∑ –æ–ø–ª–∞—Ç–æ—é, –¥–æ—Å—Ç—É–ø –¥–æ –∞–∫–∞—É–Ω—Ç—É —Ç–æ—â–æ)")
    satisfaction: Literal["satisfied", "neutral", "unsatisfied"] = Field(description="–û—Ü—ñ–Ω–∫–∞ –∑–∞–¥–æ–≤–æ–ª–µ–Ω–æ—Å—Ç—ñ –∫–ª—ñ—î–Ω—Ç–∞")
    quality_score: int = Field(description="–û—Ü—ñ–Ω–∫–∞ —è–∫–æ—Å—Ç—ñ —Ä–æ–±–æ—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –≤—ñ–¥ 1 –¥–æ 5")
    agent_mistakes: list[Literal[
        "ignored_question",
        "incorrect_info",
        "rude_tone",
        "no_resolution",
        "unnecessary_escalation"
    ]] = Field(description="–°–ø–∏—Å–æ–∫ –∑–Ω–∞–π–¥–µ–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫. –ü–æ—Ä–æ–∂–Ω—ñ–π –º–∞—Å–∏–≤ [], —è–∫—â–æ –ø–æ–º–∏–ª–æ–∫ –Ω–µ–º–∞—î.")


# 2. –û–ß–ò–©–ï–ù–ò–ô –¢–ê –°–¢–†–£–ö–¢–£–†–û–í–ê–ù–ò–ô –ü–†–û–ú–ü–¢
system_instruction = """
–¢–∏ - –≥–æ–ª–æ–≤–Ω–∏–π —ñ–Ω—Å–ø–µ–∫—Ç–æ—Ä –∑ –∫–æ–Ω—Ç—Ä–æ–ª—é —è–∫–æ—Å—Ç—ñ —Å–ª—É–∂–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–æ–º–ø–∞–Ω—ñ—ó "–ö–ê–†–ò–ë–û".
–¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è - –≥–ª–∏–±–æ–∫–æ —Ç–∞ –æ–±'—î–∫—Ç–∏–≤–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –¥—ñ–∞–ª–æ–≥. –£–≤–∞–∂–Ω–æ —á–∏—Ç–∞–π –ø—ñ–¥—Ç–µ–∫—Å—Ç.
–°–ü–û–ß–ê–¢–ö–£ –Ω–∞–ø–∏—à–∏ —Å–≤–æ—î –æ–±“ë—Ä—É–Ω—Ç—É–≤–∞–Ω–Ω—è (reasoning), –∞ –ø–æ—Ç—ñ–º –≤–∏—Å—Ç–∞–≤–ª—è–π –æ—Ü—ñ–Ω–∫–∏.

–ü–†–ê–í–ò–õ–û –ù–ï–ó–ê–õ–ï–ñ–ù–û–°–¢–Ü: 
–û—Ü—ñ–Ω–∫–∞ –∑–∞–¥–æ–≤–æ–ª–µ–Ω–æ—Å—Ç—ñ –∫–ª—ñ—î–Ω—Ç–∞ (satisfaction) –ù–ï –≤–ø–ª–∏–≤–∞—î –ø—Ä—è–º–æ –Ω–∞ –æ—Ü—ñ–Ω–∫—É —è–∫–æ—Å—Ç—ñ —Ä–æ–±–æ—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (quality_score). –û–ø–µ—Ä–∞—Ç–æ—Ä –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ 5, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –∫–ª—ñ—î–Ω—Ç –ø—ñ—à–æ–≤ —Ä–æ–∑–ª—é—á–µ–Ω–∏–º —á–µ—Ä–µ–∑ –ø–æ–ª—ñ—Ç–∏–∫—É –∫–æ–º–ø–∞–Ω—ñ—ó, —è–∫—É –Ω–µ–º–æ–∂–ª–∏–≤–æ –∑–º—ñ–Ω–∏—Ç–∏.

–ö–†–ò–¢–ï–†–Ü–á –ó–ê–î–û–í–û–õ–ï–ù–û–°–¢–Ü –ö–õ–Ü–Ñ–ù–¢–ê (satisfaction):
- "satisfied": –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é –≤–∏—Ä—ñ—à–µ–Ω–∞, –∫–ª—ñ—î–Ω—Ç —â–∏—Ä–æ –≤–¥—è—á–Ω–∏–π.
- "neutral": –ø—Ä–æ–±–ª–µ–º—É –≤–∏—Ä—ñ—à–µ–Ω–æ –ø—ñ—Å–ª—è –¥–æ–≤–≥–∏—Ö –ø–æ—è—Å–Ω–µ–Ω—å; –ê–ë–û –ø—Ä–æ–±–ª–µ–º—É –Ω–µ –≤–∏—Ä—ñ—à–µ–Ω–æ, –∞–ª–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ –≤—Å–µ –ø–æ—è—Å–Ω–∏–≤ —ñ –∫–ª—ñ—î–Ω—Ç —Å–ø–æ–∫—ñ–π–Ω–æ —Ü–µ –ø—Ä–∏–π–Ω—è–≤ (—á–∏ –ø—Ä–æ—Å—Ç–æ –∑–¥–∞–≤—Å—è, —Ñ–æ—Ä–º–∞–ª—å–Ω–æ –Ω–∞–ø–∏—Å–∞–≤—à–∏ "–¥—è–∫—É—é").
- "unsatisfied": –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤–∏—Ä—ñ—à–µ–Ω–∞, –∫–ª—ñ—î–Ω—Ç —Ä–æ–∑–¥—Ä–∞—Ç–æ–≤–∞–Ω–∏–π/–∞–≥—Ä–µ—Å–∏–≤–Ω–∏–π; –ê–ë–û –∫–ª—ñ—î–Ω—Ç –ø—ñ—à–æ–≤ —á–µ—Ä–µ–∑ –≥—Ä—É–±—ñ—Å—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.

–ö–†–ò–¢–ï–†–Ü–á –Ø–ö–û–°–¢–Ü –û–ü–ï–†–ê–¢–û–†–ê (quality_score):
- 5: –Ü–¥–µ–∞–ª—å–Ω–∞ —Ä–æ–±–æ—Ç–∞. –®–≤–∏–¥–∫–µ —Ä–æ–∑—É–º—ñ–Ω–Ω—è, —á—ñ—Ç–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º. (–¢–∞–∫–æ–∂ 5, —è–∫—â–æ –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Ñ—ñ–∑–∏—á–Ω–æ –Ω–µ–º–æ–∂–ª–∏–≤–æ —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–º–ø–∞–Ω—ñ—ó, –∞–ª–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä –±—É–≤ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –µ–º–ø–∞—Ç–∏—á–Ω–∏–º —ñ –¥–∞–≤ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É/–Ω–∞–ø—Ä—è–º–æ–∫).
- 4: –ü—Ä–æ–±–ª–µ–º–∞ –≤–∏—Ä—ñ—à–µ–Ω–∞, –∞–ª–µ –±—É–ª–∏ –∑–∞–π–≤—ñ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è; –ê–ë–û –¥–æ–ø–æ–º–æ–≥—Ç–∏ –Ω–µ–º–æ–∂–ª–∏–≤–æ, –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤–≤—ñ—á–ª–∏–≤–æ —Ü–µ –ø–æ—è—Å–Ω–∏–≤, –∞–ª–µ –Ω–µ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞–≤ –∫—É–¥–∏ –∑–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ.
- 3: –û–ø–µ—Ä–∞—Ç–æ—Ä –±—É–≤ –≤–≤—ñ—á–ª–∏–≤–∏–º, –∞–ª–µ —Ä—ñ—à–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π—à–æ–≤; –ê–ë–û –∑–Ω–∞–π—à–æ–≤ —Ä—ñ—à–µ–Ω–Ω—è, –∞–ª–µ –∫–ª—ñ—î–Ω—Ç –¥—É–∂–µ –¥–æ–≤–≥–æ —á–µ–∫–∞–≤; –ê–ë–û –æ–ø–µ—Ä–∞—Ç–æ—Ä –∫–∏–¥–∞–≤ —Å—É—Ö—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó, —ñ–≥–Ω–æ—Ä—É—é—á–∏ –µ–º–æ—Ü—ñ–π–Ω–∏–π —Å—Ç–∞–Ω –∫–ª—ñ—î–Ω—Ç–∞.
- 2: –®–∞–±–ª–æ–Ω–Ω—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ, —è–∫—ñ –Ω–µ —Å—Ç–æ—Å—É—é—Ç—å—Å—è —Å—É—Ç—ñ. –Ü–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è —á–∞—Å—Ç–∏–Ω–∏ –∑–∞–ø–∏—Ç–∞–Ω—å.
- 1: –ó–≤–∏–Ω—É–≤–∞—á–µ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞ ("–≤–∏ —Å–∞–º—ñ –≤–∏–Ω–Ω—ñ"), —Å—É–ø–µ—Ä–µ—á–∫–∞, –≥—Ä—É–±—ñ—Å—Ç—å, —Ä–æ–∑–≥–æ–ª–æ—à–µ–Ω–Ω—è –æ—Å–æ–±–∏—Å—Ç–∏—Ö –¥–∞–Ω–∏—Ö.

–¢–ò–ü–Ü–ó–ê–¶–Ü–Ø –ü–û–ú–ò–õ–û–ö (agent_mistakes):
- "ignored_question": —ñ–≥–Ω–æ—Ä—É–≤–∞–Ω–Ω—è –ø—Ä—è–º–æ–≥–æ –∑–∞–ø–∏—Ç—É. (–í–∏–Ω—è—Ç–æ–∫: —è–∫—â–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ—ñ–≥–Ω–æ—Ä—É–≤–∞–≤, –∞–ª–µ –ø–æ—Ç—ñ–º –≤–∏–ø—Ä–∞–≤–∏–≤—Å—è ‚Äî —Ü–µ –ù–ï –ø–æ–º–∏–ª–∫–∞).
- "incorrect_info": —Ç–µ—Ö–Ω—ñ—á–Ω–æ –Ω–µ–≥—Ä–∞–º–æ—Ç–Ω—ñ, –∞–±—Å—É—Ä–¥–Ω—ñ –ø–æ—Ä–∞–¥–∏.
- "rude_tone": –∑–≤–µ—Ä—Ö–Ω—ñ—Å—Ç—å, —Å–∞—Ä–∫–∞–∑–º, —Ç–æ–∫—Å–∏—á–Ω–∞ –ø–æ–∑–∏—Ç–∏–≤–Ω—ñ—Å—Ç—å (—Å–º–∞–π–ª–∏–∫–∏, –∫–æ–ª–∏ –∫–ª—ñ—î–Ω—Ç –≤ —ñ—Å—Ç–µ—Ä–∏—Ü—ñ), –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è/–ø—Ä–æ—â–∞–Ω–Ω—è.
- "no_resolution": –¥—ñ–∞–ª–æ–≥ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è –±–µ–∑ —Ä—ñ—à–µ–Ω–Ω—è —ñ –±–µ–∑ –ø—ñ–¥–∫–∞–∑–∫–∏, —â–æ —Ä–æ–±–∏—Ç–∏ –¥–∞–ª—ñ. (–í–∏–Ω—è—Ç–æ–∫: —è–∫—â–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä –ù–ï –º–æ–∂–µ –¥–æ–ø–æ–º–æ–≥—Ç–∏ —á–µ—Ä–µ–∑ —Å—É–≤–æ—Ä—ñ –ø—Ä–∞–≤–∏–ª–∞ –∫–æ–º–ø–∞–Ω—ñ—ó (unsolvable_policy), —ñ —á—ñ—Ç–∫–æ —Ü–µ –ø–æ—è—Å–Ω–∏–≤ ‚Äî —Ü–µ –ù–ï no_resolution).
- "unnecessary_escalation": –≤—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥–æ —ñ–Ω—à–æ–≥–æ –≤—ñ–¥–¥—ñ–ª—É –∞–±–æ –ø–ª–∞—Ç–Ω–æ–≥–æ –º–∞–π—Å—Ç—Ä–∞ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ—ó –ø–æ—Ç—Ä–µ–±–∏.
"""


def analyze_dialogue(chat_data: dict) -> dict:
    # –ü–µ—Ä–µ–¥–∞—î–º–æ –Ω–µ —Ç—ñ–ª—å–∫–∏ —Ç–µ–∫—Å—Ç, –∞ –≤–µ—Å—å JSON (–≤–∫–ª—é—á–∞—é—á–∏ metadata, —è–∫—â–æ –≤–æ–Ω–∏ —î)
    chat_str = json.dumps(chat_data, ensure_ascii=False, indent=2)

    response = client.beta.chat.completions.parse(
        model="gpt-4o-mini",
        messages=[
            {"role": "system", "content": system_instruction},
            {"role": "user", "content": f"–û—Å—å –¥–∞–Ω—ñ –¥—ñ–∞–ª–æ–≥—É (–º–æ–∂—É—Ç—å –≤–∫–ª—é—á–∞—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω—ñ) –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É:\n{chat_str}"}
        ],
        response_format=AnalysisResult,
        temperature=0.0,
        top_p=1.0,
        seed=13
    )

    return response.choices[0].message.parsed.model_dump()


def process_chat(item):
    index, chat = item
    chat_id = f"chat_{index + 1}"

    print(f"üîç –ê–Ω–∞–ª—ñ–∑—É—é {chat_id}...")

    max_attempt = 3
    for attempt in range(max_attempt):
        try:
            # –ü–µ—Ä–µ–¥–∞—î–º–æ –≤–µ—Å—å –æ–±'—î–∫—Ç chat, —â–æ–± –®–Ü –±–∞—á–∏–≤ metadata (intent, scenario)
            analysis = analyze_dialogue(chat)
            return {
                "chat_id": chat_id,
                "original_data": chat,  # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ
                "analysis": analysis
            }
        except Exception as e:
            print(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –≤ {chat_id} (–°–ø—Ä–æ–±–∞ {attempt + 1}): {e}")
            if attempt < max_attempt - 1:
                time.sleep(2)
            else:
                print(f"‚ùå –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ {chat_id}")
                return None
    return None


def main():
    dataset_file_name = "dataset.json"

    try:
        with open(dataset_file_name, "r", encoding="utf-8") as f:
            chats = json.load(f)
    except FileNotFoundError:
        print(f"‚ùå –§–∞–π–ª {dataset_file_name} –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ :(")
        return

    start_time = time.time()
    results = []
    tasks = list(enumerate(chats))

    with ThreadPoolExecutor(max_workers=5) as executor:
        processed_results = list(executor.map(process_chat, tasks))

    for res in processed_results:
        if res:
            results.append(res)

    with open("results.json", "w", encoding="utf-8") as f:
        json.dump(results, f, ensure_ascii=False, indent=4)

    print(f"‚úÖ –ê–Ω–∞–ª—ñ–∑ —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –û–±—Ä–æ–±–ª–µ–Ω–æ {len(results)} —á–∞—Ç—ñ–≤.")
    print(f"‚è± –ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: {time.time() - start_time:.2f}—Å")


if __name__ == "__main__":
    main()