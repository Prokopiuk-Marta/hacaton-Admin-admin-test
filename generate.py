import os
import json
import random
from dotenv import load_dotenv
from openai import OpenAI
from pydantic import BaseModel
from concurrent.futures import ThreadPoolExecutor
import time

load_dotenv()
api_key = os.getenv("OpenAI_api_key")

if not api_key:
    raise ValueError("–ö–ª—é—á OpenAI_api_key –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!")

client = OpenAI(api_key=api_key)


class Message(BaseModel):
    role: str
    text: str


class DialogueResponse(BaseModel):
    dialogue: list[Message]


intents = [
    "–ø—Ä–æ–±–ª–µ–º–∏ –∑ –æ–ø–ª–∞—Ç–æ—é",
    "—Ç–µ—Ö–Ω—ñ—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏",
    "–¥–æ—Å—Ç—É–ø –¥–æ –∞–∫–∞—É–Ω—Ç—É",
    "–ø–∏—Ç–∞–Ω–Ω—è –ø–æ —Ç–∞—Ä–∏—Ñ—É",
    "–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—à—Ç—ñ–≤",
    "–∑–º—ñ–Ω–∞ –æ—Å–æ–±–∏—Å—Ç–∏—Ö –¥–∞–Ω–∏—Ö"
]


scenario_instructions = {
    "successful_case": """
        –°–∏—Ç—É–∞—Ü—ñ—è: –û–ø–µ—Ä–∞—Ç–æ—Ä –¥—ñ—î –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ, —à–≤–∏–¥–∫–æ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å —Ä—ñ—à–µ–Ω–Ω—è.
        –ö–ª—ñ—î–Ω—Ç: –°–ø–æ—á–∞—Ç–∫—É —Å—Ç—É—Ä–±–æ–≤–∞–Ω–∏–π, –∞–ª–µ –≤ –∫—ñ–Ω—Ü—ñ —â–∏—Ä–æ –¥—è–∫—É—î —ñ –∑–∞–¥–æ–≤–æ–ª–µ–Ω–∏–π —Å–µ—Ä–≤—ñ—Å–æ–º.
        –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü—Ä–æ–±–ª–µ–º–∞ –≤–∏—Ä—ñ—à–µ–Ω–∞ –ø–æ–≤–Ω—ñ—Å—Ç—é.
    """,

    "hidden_dissatisfaction": """
        –°–∏—Ç—É–∞—Ü—ñ—è: –û–ø–µ—Ä–∞—Ç–æ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —à–∞–±–ª–æ–Ω–Ω–æ –∞–±–æ –Ω–µ –∑–∞–≥–ª–∏–±–ª—é—î—Ç—å—Å—è –≤ —Å—É—Ç—å.
        –ö–ª—ñ—î–Ω—Ç: –§–æ—Ä–º–∞–ª—å–Ω–æ –≤–≤—ñ—á–ª–∏–≤–∏–π, –∞–ª–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ö–æ–ª–æ–¥–Ω—ñ —Ñ—Ä–∞–∑–∏ ('–∑—Ä–æ–∑—É–º—ñ–ª–æ', '–Ω—É –¥–æ–±—Ä–µ', '—è –ø–æ—á—É–≤').
        –í–ê–ñ–õ–ò–í–û: –ö–ª—ñ—î–Ω—Ç –ù–ï –∫–∞–∂–µ –ø—Ä—è–º–æ, —â–æ –≤—ñ–Ω –Ω–µ–∑–∞–¥–æ–≤–æ–ª–µ–Ω–∏–π, –∞–ª–µ –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤–∏–¥–Ω–æ, —â–æ –≤—ñ–Ω –ø—Ä–æ—Å—Ç–æ –∑–¥–∞–≤—Å—è.
        –§—ñ–Ω–∞–ª: –ö–ª—ñ—î–Ω—Ç –ø—Ä–∏–ø–∏–Ω—è—î –¥—ñ–∞–ª–æ–≥, –Ω–µ –æ—Ç—Ä–∏–º–∞–≤—à–∏ —Ä–µ–∞–ª—å–Ω–æ—ó –¥–æ–ø–æ–º–æ–≥–∏, –∞–ª–µ –Ω–µ –≤–ª–∞—à—Ç–æ–≤—É—î —Å–∫–∞–Ω–¥–∞–ª.
    """,

    "conflict_case": """
        –°–∏—Ç—É–∞—Ü—ñ—è: –ö–ª—ñ—î–Ω—Ç –∑ —Å–∞–º–æ–≥–æ –ø–æ—á–∞—Ç–∫—É –∞–≥—Ä–µ—Å–∏–≤–Ω–∏–π, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∫–∞–ø—Å, –∑–Ω–∞–∫–∏ –æ–∫–ª–∏–∫—É, –º–æ–∂–ª–∏–≤–æ –ª–µ–≥–∫—ñ –æ–±—Ä–∞–∑–∏.
        –û–ø–µ—Ä–∞—Ç–æ—Ä: –ù–∞–º–∞–≥–∞—î—Ç—å—Å—è –∑–∞—Å–ø–æ–∫–æ—ó—Ç–∏, –∞–ª–µ –∫–ª—ñ—î–Ω—Ç –Ω–µ —Å–ª—É—Ö–∞—î –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤.
        –†–µ–∑—É–ª—å—Ç–∞—Ç: –ö–ª—ñ—î–Ω—Ç –∫–∏–¥–∞—î —Å–ª—É—Ö–∞–≤–∫—É –∞–±–æ –ø–æ–≥—Ä–æ–∂—É—î –ø—ñ—Ç–∏ –¥–æ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤. –ü—Ä–æ–±–ª–µ–º–∞ –Ω–µ –≤–∏—Ä—ñ—à–µ–Ω–∞ —á–µ—Ä–µ–∑ –µ–º–æ—Ü—ñ—ó.
    """,

    "agent_mistake_tone": """
        –°–∏—Ç—É–∞—Ü—ñ—è: –ö–ª—ñ—î–Ω—Ç —Å—Ç–∞–≤–∏—Ç—å –∑–≤–∏—á–∞–π–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è.
        –û–ø–µ—Ä–∞—Ç–æ—Ä: –í—ñ–¥–ø–æ–≤—ñ–¥–∞—î –∑–≤–µ—Ä—Ö–Ω—å–æ, –≥—Ä—É–±–æ –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø–∞—Å–∏–≤–Ω–æ-–∞–≥—Ä–µ—Å–∏–≤–Ω–∏–π —Ç–æ–Ω (rude_tone).
        –ö–ª—ñ—î–Ω—Ç: –®–æ–∫–æ–≤–∞–Ω–∏–π —Ç–∞–∫–æ—é –ø–æ–≤–µ–¥—ñ–Ω–∫–æ—é, —Ä–æ–±–∏—Ç—å –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è.
    """,

    "agent_mistake_logic": """
        –°–∏—Ç—É–∞—Ü—ñ—è: –ö–ª—ñ—î–Ω—Ç –æ–ø–∏—Å—É—î –ø—Ä–æ–±–ª–µ–º—É.
        –û–ø–µ—Ä–∞—Ç–æ—Ä: –î–∞—î –ø–æ—Ä–∞–¥—É, —è–∫–∞ –∞–±—Å–æ–ª—é—Ç–Ω–æ –Ω–µ —Å—Ç–æ—Å—É—î—Ç—å—Å—è —Ç–µ–º–∏ (incorrect_info) –∞–±–æ —ñ–≥–Ω–æ—Ä—É—î –ø—Ä—è–º–µ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è (ignored_question).
        –ö–ª—ñ—î–Ω—Ç: –í–∫–∞–∑—É—î –Ω–∞ —Ç–µ, —â–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä –π–æ–≥–æ –Ω–µ —Å–ª—É—Ö–∞—î.
    """,


    "unsolvable_policy": """
        –°–∏—Ç—É–∞—Ü—ñ—è: –ö–ª—ñ—î–Ω—Ç –≤–∏–º–∞–≥–∞—î —Ç–µ, —â–æ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–∞–º–∏ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—à—Ç—ñ–≤ —á–µ—Ä–µ–∑ —Ä—ñ–∫ –∞–±–æ –¥–æ—Å—Ç—É–ø –¥–æ —á—É–∂–æ–≥–æ –∞–∫–∞—É–Ω—Ç—É).
        –û–ø–µ—Ä–∞—Ç–æ—Ä: –í–≤—ñ—á–ª–∏–≤–æ, –∞–ª–µ —Ç–≤–µ—Ä–¥–æ –í–Ü–î–ú–û–í–õ–Ø–Ñ, –ø–æ—Å–∏–ª–∞—é—á–∏—Å—å –Ω–∞ –ø—Ä–∞–≤–∏–ª–∞. –¶–µ –ù–ï –ø–æ–º–∏–ª–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
        –ö–ª—ñ—î–Ω—Ç: –ó–∞–ª–∏—à–∞—î—Ç—å—Å—è –Ω–µ–∑–∞–¥–æ–≤–æ–ª–µ–Ω–∏–º —Ñ–∞–∫—Ç–æ–º –≤—ñ–¥–º–æ–≤–∏, –∞–ª–µ –ø—Ä–µ—Ç–µ–Ω–∑—ñ–π –¥–æ —Ä–æ–±–æ—Ç–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –Ω–µ –º–∞—î (–∞–±–æ –∑–º–∏—Ä–∏–≤—Å—è).
        –†–µ–∑—É–ª—å—Ç–∞—Ç: –Ø–∫—ñ—Å–Ω–∞ —Ä–æ–±–æ—Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ø—Ä–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω–æ–º—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞.
    """
}

agents_names = ["–ú–∞–∫—Å–∏–º", "–û–ª–µ–Ω–∞", "–î–º–∏—Ç—Ä–æ", "–ê–ª—ñ–Ω–∞", "–°–µ—Ä–≥—ñ–π"]


def generate_dialogue(intent, scenario_key):
    detailed_instruction = scenario_instructions[scenario_key]
    agent_name = random.choice(agents_names)

    system_instruction = f"""
    –¢–∏ ‚Äî —Å—Ü–µ–Ω–∞—Ä–∏—Å—Ç —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏—Ö –¥—ñ–∞–ª–æ–≥—ñ–≤ –¥–ª—è —Ç—Ä–µ–Ω—É–≤–∞–Ω–Ω—è AI.
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –Ω–∞–ø–∏—Å–∞—Ç–∏ –¥—ñ–∞–ª–æ–≥ –º—ñ–∂ –ö–ª—ñ—î–Ω—Ç–æ–º —Ç–∞ –°–∞–ø–æ—Ä—Ç-–∞–≥–µ–Ω—Ç–æ–º –∫–æ–º–ø–∞–Ω—ñ—ó "–ö–ê–†–ò–ë–û".

    –ü–ï–†–°–û–ù–ê–õ–Ü–ó–ê–¶–Ü–Ø:
    1. –ö–ª—ñ—î–Ω—Ç: –ñ–∏–≤–∞ –ª—é–¥–∏–Ω–∞. –ú–æ–∂–µ –ø–∏—Å–∞—Ç–∏ –∑ –ø–æ–º–∏–ª–∫–∞–º–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Å—É—Ä–∂–∏–∫, —Å–ª–µ–Ω–≥, –ø—Ä–æ–ø—É—Å–∫–∞—Ç–∏ –∫–æ–º–∏.
    2. –û–ø–µ—Ä–∞—Ç–æ—Ä ({agent_name}): –î–æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è —Å–∫—Ä–∏–ø—Ç—ñ–≤, –∞–ª–µ –º–∞—î "–ª—é–¥—Å—å–∫–µ –æ–±–ª–∏—á—á—è".

    –ó–ê–ë–û–†–û–ù–ò:
    - –ù–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Ñ—Ä–∞–∑—É "–Ø—Å–Ω–æ, –¥—è–∫—É—é" —É –∫–æ–∂–Ω–æ–º—É –¥—ñ–∞–ª–æ–∑—ñ —Ç–∞ –∫–æ–ª–∏ –¥—ñ–∞–ª–æ–≥ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è, –Ω–∞–º–∞–≥–∞–π—Å—è –∏–µ–Ω—à–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ
    - –ù–µ —Ä–æ–±–∏ –¥—ñ–∞–ª–æ–≥–∏ –∑–∞–Ω–∞–¥—Ç–æ "—Ä–æ–±–æ—Ç–∏–∑–æ–≤–∞–Ω–∏–º–∏", –Ω–µ –∑–∞–±—É–≤–∞–π —â–æ –∫–ª—ñ—î–Ω—Ç - –∂–∏–≤–∞ –ª—é–¥–∏–Ω–∞.
    """

    prompt = f"""
    –¢–ï–ú–ê –ó–í–ï–†–ù–ï–ù–ù–Ø: {intent}
    –°–¶–ï–ù–ê–†–Ü–ô: {scenario_key}
    –î–ï–¢–ê–õ–Ü –°–¶–ï–ù–ê–†–Ü–Æ: {detailed_instruction}

    –°–¢–†–£–ö–¢–£–†–ê:
    1. –ü–æ—á–∞—Ç–æ–∫: '{agent_name}, –ø—ñ–¥—Ç—Ä–∏–º–∫–∞ –ö–ê–†–ò–ë–û. –°–ª—É—Ö–∞—é –≤–∞—Å.' (–∞–±–æ –≤–∞—Ä—ñ–∞—Ü—ñ—ó).
    2. –î–æ–≤–∂–∏–Ω–∞: 5-9 —Ä–µ–ø–ª—ñ–∫ (–∑—Ä–æ–±–∏ –¥—ñ–∞–ª–æ–≥ –∑–º—ñ—Å—Ç–æ–≤–Ω–∏–º).
    3. –ö–æ–Ω—Ç–µ–∫—Å—Ç: –¶–µ —á–∞—Ç —É –º–µ—Å–µ–Ω–¥–∂–µ—Ä—ñ.
    """

    for attempt in range(3):
        try:
            response = client.beta.chat.completions.parse(
                model="gpt-4o-mini",
                messages=[
                    {"role": "system", "content": system_instruction},
                    {"role": "user", "content": prompt}
                ],
                response_format=DialogueResponse,
                temperature=1.0,
            )

            result = response.choices[0].message.parsed.model_dump()
            result["intent"] = intent
            result["scenario_type"] = scenario_key


            result["expected_satisfaction"] = "satisfied" if "successful" in scenario_key else "unsatisfied"
            if "unsolvable" in scenario_key:
                result["expected_satisfaction"] = "neutral"

            return result

        except Exception as e:
            print(f"–ü–û–ú–ò–õ–ö–ê: {intent} + {scenario_key} (–°–ø—Ä–æ–±–∞ {attempt + 1}): {e}")
            time.sleep(1)

    print(f"–û—Å—Ç–∞—Ç–æ—á–Ω–∏–π –ø—Ä–æ–≤–∞–ª –¥–ª—è {intent} + {scenario_key}. –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ.")
    return None


if __name__ == "__main__":
    start_time = time.time()
    print("üöÄ –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø–æ–∫—Ä–∞—â–µ–Ω–æ–≥–æ –¥–∞—Ç–∞—Å–µ—Ç—É...")

    tasks = []

    for _ in range(2):
        for intent in intents:
            for scenario in scenario_instructions.keys():
                tasks.append((intent, scenario))


    random.shuffle(tasks)

    with ThreadPoolExecutor(max_workers=8) as executor:
        results = list(executor.map(lambda x: generate_dialogue(x[0], x[1]), tasks))

    dataset = [res for res in results if res]

    with open("dataset.json", "w", encoding="utf-8") as file:
        json.dump(dataset, file, ensure_ascii=False, indent=4)

    print(f"–ì–æ—Ç–æ–≤–æ! –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ {len(dataset)} –¥—ñ–∞–ª–æ–≥—ñ–≤. –ß–∞—Å: {time.time() - start_time:.2f}—Å")