import os
import json
from dotenv import load_dotenv
from openai import OpenAI
from pydantic import BaseModel
from concurrent.futures import ThreadPoolExecutor
import time

load_dotenv()
api_key = os.getenv("OpenAI_api_key")

if not api_key:
    raise ValueError("–ö–ª—é—á OPENAI_API_KEY –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ! –ü–µ—Ä–µ–≤—ñ—Ä —Ñ–∞–π–ª .env")

client = OpenAI(api_key=api_key)


class Message(BaseModel):
    role: str
    text: str


class DialogueResponse(BaseModel):
    dialogue: list[Message]


intents = [
    "–ø—Ä–æ–±–ª–µ–º–∏ –∑ –æ–ø–ª–∞—Ç–æ—é",
    "–¥–æ—Å—Ç—É–ø –¥–æ –∞–∫–∞—É–Ω—Ç—É",
    "—Ç–µ—Ö–Ω—ñ—á–Ω—ñ –ø–æ–º–∏–ª–∫–∏",
    "–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∫–æ—à—Ç—ñ–≤",
    "–ø–∏—Ç–∞–Ω–Ω—è –ø–æ —Ç–∞—Ä–∏—Ñ—É"
]
scenario_instructions = {
    "???—É—Å–ø—ñ—à–Ω–∏–π –∫–µ–π—Å": """–ö–ª—ñ—î–Ω—Ç —á—ñ—Ç–∫–æ —Ä–æ–∑—É–º—ñ—î –ø—Ä–æ–±–ª–µ–º—É ('—Ö–æ—á—É –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –Ω–æ–≤–∏–π —Ç–∞—Ä–∏—Ñ'), –∞ –∞–≥–µ–Ω—Ç —à–≤–∏–¥–∫–æ —Ç–∞ 
    –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–æ –π–æ–º—É –¥–æ–ø–æ–º–∞–≥–∞—î. –ö–ª—ñ—î–Ω—Ç –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –∑–∞–¥–æ–≤–æ–ª–µ–Ω–∏–º.""",

    "–ø—Ä–∏—Ö–æ–≤–∞–Ω–∞ –Ω–µ–∑–∞–¥–æ–≤–æ–ª–µ–Ω—ñ—Å—Ç—å": """–ê–≥–µ–Ω—Ç –Ω–µ –≤–∏—Ä—ñ—à—É—î –ø—Ä–æ–±–ª–µ–º—É. –ö–ª—ñ—î–Ω—Ç —Ä–æ–∑—É–º—ñ—î, —â–æ —Å–ø–µ—Ä–µ—á–∞—Ç–∏—Å—è –º–∞—Ä–Ω–æ, —Ç–æ–º—É 
    –≤ –∫—ñ–Ω—Ü—ñ –≤–≤—ñ—á–ª–∏–≤–æ, –∞–ª–µ —Å—É—Ö–æ –¥—è–∫—É—î —ñ –ø—Ä–æ—â–∞—î—Ç—å—Å—è.""",

    "–∫–æ–Ω—Ñ–ª—ñ–∫—Ç–Ω–∏–π –∫–µ–π—Å": """–ö–ª—ñ—î–Ω—Ç –¥—É–∂–µ –Ω–µ—Ä–≤–æ–≤–∏–π –∞–±–æ —Ä–æ–∑–¥—Ä–∞—Ç–æ–≤–∞–Ω–∏–π. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: –∫–∞–∂–µ, —â–æ –±–æ—ó—Ç—å—Å—è –µ–ª–µ–∫—Ç—Ä–∏–∫–∏, 
    —Ç–æ–º—É –Ω–µ –±—É–¥–µ —á—ñ–ø–∞—Ç–∏ —Ä–æ—É—Ç–µ—Ä, —ñ –≤–∏–º–∞–≥–∞—î –º–∞–π—Å—Ç—Ä–∞ –¥–æ–¥–æ–º—É. –ê–≥–µ–Ω—Ç –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –π–æ–≥–æ –∑–∞—Å–ø–æ–∫–æ—ó—Ç–∏, –æ–¥–Ω–∞–∫ –∫–ª—ñ—î–Ω—Ç
    –ø–æ—á–∏–Ω–∞—î –∞–≥—Ä–µ—Å—É–≤–∞—Ç–∏.""",

    "–ø–æ–º–∏–ª–∫–∞ –∞–≥–µ–Ω—Ç–∞": """–ê–≥–µ–Ω—Ç –≤–µ–¥–µ —Å–µ–±–µ –Ω–µ—Ç–∞–∫—Ç–æ–≤–Ω–æ. –ù–µ –≤—ñ—Ç–∞—î—Ç—å—Å—è, –ø–æ–∫–∞–∑—É—î —Å–≤–æ—î —Ä–æ–∑–¥—Ä–∞—Ç—É–≤–∞–Ω–Ω—è, –º–æ–∂–µ —Å–∫–∞–∑–∞—Ç–∏, 
    —â–æ –∫–ª—ñ—î–Ω—Ç —Ç—É–ø–∏–π, –∞–±–æ —Ä–æ–∑–∫–∞–∑—É—î –æ—Å–æ–±–∏—Å—Ç—É —á–∏ –∫–æ–Ω—Ñ—ñ–¥–µ–Ω—Ü—ñ–π–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é. –í—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Å–≤–∞—Ä–∫–∞.""",

    "–Ω–µ–∑—Ä–æ–∑—É–º—ñ–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞": """–ö–ª—ñ—î–Ω—Ç –Ω–µ —Ä–æ–∑—É–º—ñ—î —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º–∏. –ù–∞–ø—Ä–∏–∫–ª–∞–¥: '–≤—ñ—Ç–∞—é —É –≤—Å—ñ—Ö –Ω–µ–º–∞ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç—É? 
    –ú–µ–Ω—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–¥–∑–≤–æ–Ω–∏—Ç–∏ –¥—Ä—É–∂–∏–Ω—ñ'. –ê–±–æ –∫–ª—ñ—î–Ω—Ç –Ω–∞–ª—è–∫–∞–Ω–∏–π —Ç–∏–º, —â–æ –ø—Ä–æ—Ñ—ñ–ª—å –±–µ–∑—Å–ª—ñ–¥–Ω–æ –∑–Ω–∏–∫, –∞–ª–µ –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ 
    –∑—Ä–æ–±–∏–≤ –æ–¥—Ä—É–∫—ñ–≤–∫—É –≤ –ø–æ—à—Ç—ñ (@gmai.com). –ê–≥–µ–Ω—Ç —Å—Ç–∞—Ä–∞—î—Ç—å—Å—è –¥–æ–ø–æ–º–æ–≥—Ç–∏ –Ω–∞–≤—ñ–¥–Ω–∏–º–∏ –∑–∞–ø–∏—Ç–∞–Ω–Ω—è–º–∏."""
}

dataset = []


def generate_dialogue(intent, scenario):
    detailed_instruction = scenario_instructions[scenario]

    prompt = f"""
        –¢–∏ ‚Äî –µ–∫—Å–ø–µ—Ä—Ç –∑—ñ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–∞–≤—á–∞–ª—å–Ω–∏—Ö –¥–∞—Ç–∞—Å–µ—Ç—ñ–≤.
        –ù–∞–ø–∏—à–∏ —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π –¥—ñ–∞–ª–æ–≥ –º—ñ–∂ –∫–ª—ñ—î–Ω—Ç–æ–º —Ç–∞ –∞–≥–µ–Ω—Ç–æ–º —Å–ª—É–∂–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –∫–æ–º–ø–∞–Ω—ñ—ó –ö–ê–†–ò–ë–û. 
        "–†–µ–∞–ª—ñ—Å—Ç–∏—á–Ω–∏–π" - –æ–∑–Ω–∞—á–∞—î,—â–æ –º–æ–∂–µ –≤—ñ–¥—ñ–≥—Ä–∞–≤–∞—Ç–∏ –ª—é–¥—Å—å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä: —ñ–Ω–æ–¥—ñ –ª—é–¥–∏ —Å–∞–º—ñ –Ω–µ —Ä–æ–∑—É–º—ñ—é—Ç—å, 
        —è–∫–∞ –≤ –Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º–∞, –º–æ–∂—É—Ç—å –¥—Ä–∞—Ç—É–≤–∞—Ç–∏—Å—å –∞–±–æ –±—É—Ç–∏ —Å–ø–æ–∫—ñ–π–Ω–∏–º–∏.

        –¢–µ–º–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è: {intent}.

        –¢–í–Ü–ô –°–¶–ï–ù–ê–†–Ü–ô –î–õ–Ø –¶–¨–û–ì–û –î–Ü–ê–õ–û–ì–£ (–°–¢–†–û–ì–û –î–û–¢–†–ò–ú–£–ô–°–Ø –ô–û–ì–û):
        {detailed_instruction}

        –ë–ê–ó–û–í–Ü –ü–†–ê–í–ò–õ–ê (–í–ò–ö–û–ù–£–ô –ó–ê–í–ñ–î–ò):
        1. –ñ–ò–í–ê –ú–û–í–ê –ö–õ–Ü–Ñ–ù–¢–ê: –ö–ª—ñ—î–Ω—Ç –ø–∏—à–µ —è–∫ –∑–≤–∏—á–∞–π–Ω–∞ –ª—é–¥–∏–Ω–∞. –Ü–Ω–æ–¥—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å–ª–µ–Ω–≥, –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –≥—Ä–∞–º–∞—Ç–∏–∫–∏ 
        —á–∏ —Ä–æ–∑–¥—ñ–ª–æ–≤–∏—Ö –∑–Ω–∞–∫—ñ–≤, —Ä–æ–±–∏ –æ–¥—Ä—É–∫—ñ–≤–∫–∏.
        2. –ü–û–í–ï–î–Ü–ù–ö–ê –ê–ì–ï–ù–¢–ê (–Ø–ö–©–û –í –°–¶–ï–ù–ê–†–Ü–á –ù–ï –í–ö–ê–ó–ê–ù–û –Ü–ù–®–ï): –ê–≥–µ–Ω—Ç –ø—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π, –∞–ª–µ –∂–∏–≤–∏–π. –û–±–æ–≤'—è–∑–∫–æ–≤–æ 
        –ø–æ—á–∏–Ω–∞—î –∑ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: "–í—ñ—Ç–∞—é, –Ω–∞ –∑–≤'—è–∑–∫—É –ú–∞–∫—Å–∏–º, –æ–ø–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Ö–ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –ö–ê–†–ò–ë–û. –ü—ñ–¥–∫–∞–∂—ñ—Ç—å, 
        —è–∫ –¥–æ –í–∞—Å –º–æ–∂–Ω–∞ –∑–≤–µ—Ä—Ç–∞—Ç–∏—Å—å?"). –ó–∞–≤–∂–¥–∏ –≤–≤—ñ—á–ª–∏–≤–æ –∑–∞–∫—ñ–Ω—á—É—î –¥—ñ–∞–ª–æ–≥, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –Ω–µ –∑–º—ñ–≥ –¥–æ–ø–æ–º–æ–≥—Ç–∏.
        3. –§–û–†–ú–ê–¢: 4-7 —Ä–µ–ø–ª—ñ–∫. –ú–æ–≤–∞ ‚Äî —É–∫—Ä–∞—ó–Ω—Å—å–∫–∞.
        """

    print(f"‚è≥ –ì–µ–Ω–µ—Ä—É—é: {intent} + {scenario}...")

    try:
        response = client.beta.chat.completions.parse(
            model = "gpt-4o-mini",
            messages = [
                {"role": "system", "content": "–¢–∏ –ø–æ–º—ñ—á–Ω–∏–∫, —è–∫–∏–π –≥–µ–Ω–µ—Ä—É—î –¥–∞—Ç–∞—Å–µ—Ç–∏ –¥—ñ–∞–ª–æ–≥—ñ–≤ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏."},
                {"role": "user", "content": prompt}
            ],
            response_format = DialogueResponse,
            temperature = 0.0,
            seed = 13
        )

        result = response.choices[0].message.parsed.model_dump()
        result["intent"] = intent
        result["scenario"] = scenario_key

        return result

    except Exception as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó {intent} + {scenario_key}: {e}")
        return None

if __name__ == "__main__":
    start_time = time.time()

    print("üöÄ –ü–æ—á–∏–Ω–∞—î–º–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∞—Ç–∞—Å–µ—Ç—É...")
    dataset = []
    tasks = []

    for intent in intents:
        for scenario_key in scenario_instructions.keys():
            tasks.append((intent, scenario_key))

    with ThreadPoolExecutor(max_workers=15) as executor:
        results = executor.map(lambda x: generate_dialogue(x[0], x[1]), tasks)

    for res in results:
        if res:
            dataset.append(res)

    with open("dataset.json", "w", encoding="utf-8") as file:
        json.dump(dataset, file, ensure_ascii=False, indent=4)

    time_end = time.time()
    time_full = time_end - start_time
    print(f"üéâ –ì–æ—Ç–æ–≤–æ! –ó–±–µ—Ä–µ–∂–µ–Ω–æ {len(dataset)} –¥—ñ–∞–ª–æ–≥—ñ–≤ —É dataset.json.")
    print(f"‚è± –ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è: {time_full:.2f} —Å–µ–∫")